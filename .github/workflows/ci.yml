name: CI - Continuous Integration

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # LINTING AND CODE QUALITY
  # ===========================================================================

  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy

    - name: Run Black (code formatter check)
      run: black --check --diff .
      continue-on-error: true

    - name: Run isort (import sorting check)
      run: isort --check-only --diff .
      continue-on-error: true

    - name: Run Flake8 (linter)
      run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true

  # ===========================================================================
  # UNIT TESTS
  # ===========================================================================

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov pytest-xdist

    - name: Run unit tests
      run: |
        pytest tests/unit/ \
          -v \
          --tb=short \
          --cov=. \
          --cov-report=xml \
          --cov-report=term \
          --junitxml=junit/unit-test-results.xml \
          -n auto

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unit
        name: unit-tests
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: junit/unit-test-results.xml

  # ===========================================================================
  # INTEGRATION TESTS
  # ===========================================================================

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov pytest-xdist

    - name: Run integration tests
      env:
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: |
        pytest tests/integration/ \
          -v \
          --tb=short \
          --cov=. \
          --cov-report=xml \
          --cov-report=term \
          --junitxml=junit/integration-test-results.xml \
          -n auto

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: integration
        name: integration-tests
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: junit/integration-test-results.xml

  # ===========================================================================
  # SEMANTIC AND WORKFLOW TESTS
  # ===========================================================================

  semantic-tests:
    name: Semantic & Workflow Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-xdist

    - name: Run semantic tests
      run: |
        pytest tests/semantic/ tests/workflows/ \
          -v \
          --tb=short \
          --junitxml=junit/semantic-test-results.xml \
          -n auto

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: semantic-test-results
        path: junit/semantic-test-results.xml

  # ===========================================================================
  # PERFORMANCE TESTS
  # ===========================================================================

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-benchmark

    - name: Run performance tests
      run: |
        pytest tests/performance/ \
          -v \
          --tb=short \
          --junitxml=junit/performance-test-results.xml \
          --benchmark-only \
          --benchmark-json=benchmark.json
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          junit/performance-test-results.xml
          benchmark.json

  # ===========================================================================
  # SECURITY SCANNING
  # ===========================================================================

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Run Safety (dependency vulnerability check)
      run: safety check --json
      continue-on-error: true

    - name: Run Bandit (security linter)
      run: bandit -r . -f json -o bandit-report.json
      continue-on-error: true

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: bandit-report.json

  # ===========================================================================
  # BUILD DOCKER IMAGE
  # ===========================================================================

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./deploy/Dockerfile.api
        push: false
        tags: baggage-ai:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker run --rm baggage-ai:${{ github.sha }} python -c "import sys; print(f'Python {sys.version}')"

  # ===========================================================================
  # TEST SUMMARY
  # ===========================================================================

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, semantic-tests, performance-tests]
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        path: test-results

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          test-results/**/*.xml
        check_name: Test Results
        comment_title: Test Summary

    - name: Comment Test Summary on PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          let summary = '## üß™ Test Summary\n\n';
          summary += '| Test Suite | Status |\n';
          summary += '|------------|--------|\n';

          const testSuites = [
            'unit-test-results',
            'integration-test-results',
            'semantic-test-results',
            'performance-test-results'
          ];

          for (const suite of testSuites) {
            const exists = fs.existsSync(`test-results/${suite}`);
            summary += `| ${suite} | ${exists ? '‚úÖ Complete' : '‚ùå Failed'} |\n`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.name,
            body: summary
          });
